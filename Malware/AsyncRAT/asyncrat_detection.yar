/*
   YARA Rules for AsyncRAT Detection
   Author: Security Analysis
   Date: 2025-12-18
   Description: Comprehensive detection rules for AsyncRAT malware family
   Reference: MalwareBazaar, MITRE ATT&CK
*/

import "pe"
import "hash"

rule AsyncRAT_Core_Functionality {
    meta:
        description = "Detects AsyncRAT core components and functionality"
        author = "Security Analysis Team"
        date = "2025-12-18"
        reference = "https://github.com/NYAN-x-CAT/AsyncRAT-C-Sharp"
        severity = "high"
        malware_family = "AsyncRAT"
        
    strings:
        // Core strings
        $s1 = "AsyncRAT" ascii wide
        $s2 = "Async_RAT" ascii wide
        $s3 = "AsyncClient" ascii wide
        $s4 = "AsyncMutex_" ascii wide
        
        // Pastebin configuration
        $pastebin1 = "pastebin.com/raw/" ascii wide
        $pastebin2 = "Pastebin" ascii wide
        
        // Plugin strings
        $plugin1 = "plugin" ascii wide nocase
        $plugin2 = "Plugins.dll" ascii wide
        
        // Method names
        $method1 = "SendPlugin" ascii wide
        $method2 = "GetHash" ascii wide
        $method3 = "SendFile" ascii wide
        $method4 = "ClientSocket" ascii wide
        
        // Network/C2
        $net1 = "CN=AsyncRAT Server" ascii wide
        $net2 = "AsyncRAT Server CA" ascii wide
        
    condition:
        uint16(0) == 0x5A4D and
        (
            (2 of ($s*)) or
            (1 of ($s*) and 2 of ($method*)) or
            (1 of ($net*) and 1 of ($method*))
        )
}

rule AsyncRAT_Certificate {
    meta:
        description = "Detects AsyncRAT by SSL certificate characteristics"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "high"
        
    strings:
        $cert1 = "CN=AsyncRAT Server" ascii wide
        $cert2 = "AsyncRAT Server CA" ascii wide
        $cert3 = "OU=AsyncRAT" ascii wide
        $cert4 = "O=AsyncRAT" ascii wide
        
    condition:
        any of them
}

rule AsyncRAT_Keylogger {
    meta:
        description = "Detects AsyncRAT keylogger functionality"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "critical"
        
    strings:
        // Keylogger specific
        $key1 = "GetAsyncKeyState" ascii wide
        $key2 = "SetWindowsHookEx" ascii wide
        $key3 = "[ENTER]" ascii wide
        $key4 = "[BACKSPACE]" ascii wide
        $key5 = "[TAB]" ascii wide
        $key6 = "[ESCAPE]" ascii wide
        
        // Log file
        $log1 = "log.tmp" ascii wide nocase
        $log2 = "keylog" ascii wide nocase
        
        // AsyncRAT indicators
        $async1 = "AsyncRAT" ascii wide
        $async2 = "Async_RAT" ascii wide
        
    condition:
        uint16(0) == 0x5A4D and
        (
            (3 of ($key*) and 1 of ($async*)) or
            (1 of ($log*) and 2 of ($key*))
        )
}

rule AsyncRAT_AntiAnalysis {
    meta:
        description = "Detects AsyncRAT anti-analysis and evasion techniques"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "high"
        
    strings:
        // VM detection
        $vm1 = "VMware" ascii wide nocase
        $vm2 = "VirtualBox" ascii wide nocase
        $vm3 = "VBOX" ascii wide nocase
        $vm4 = "Sandboxie" ascii wide nocase
        $vm5 = "vmtoolsd" ascii wide nocase
        
        // Anti-debug
        $debug1 = "IsDebuggerPresent" ascii wide
        $debug2 = "CheckRemoteDebuggerPresent" ascii wide
        $debug3 = "NtQueryInformationProcess" ascii wide
        
        // AMSI/ETW patching
        $amsi1 = "AmsiScanBuffer" ascii wide
        $amsi2 = "amsi.dll" ascii wide nocase
        $etw1 = "EtwEventWrite" ascii wide
        $etw2 = "ntdll.dll" ascii wide
        
        // Process critical
        $critical1 = "RtlSetProcessIsCritical" ascii wide
        
        // AsyncRAT markers
        $async = "AsyncRAT" ascii wide
        
    condition:
        uint16(0) == 0x5A4D and
        (
            ($async and (2 of ($vm*) or 1 of ($debug*))) or
            (2 of ($amsi*) or 2 of ($etw*)) or
            $critical1
        )
}

rule AsyncRAT_Persistence {
    meta:
        description = "Detects AsyncRAT persistence mechanisms"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "medium"
        
    strings:
        // Registry persistence
        $reg1 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" ascii wide nocase
        $reg2 = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" ascii wide nocase
        
        // Scheduled task
        $task1 = "schtasks" ascii wide nocase
        $task2 = "Skype Updater" ascii wide
        $task3 = "Windows Updater" ascii wide
        $task4 = "/create /tn" ascii wide nocase
        
        // Startup folder
        $startup = "\\Microsoft\\Windows\\Start Menu\\Programs\\Startup" ascii wide nocase
        
        // AsyncRAT marker
        $async = "AsyncRAT" ascii wide
        
    condition:
        uint16(0) == 0x5A4D and
        (
            ($async and (1 of ($reg*) or 2 of ($task*) or $startup)) or
            (2 of ($task*) and 1 of ($reg*))
        )
}

rule AsyncRAT_ProcessInjection {
    meta:
        description = "Detects AsyncRAT process injection techniques"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "high"
        
    strings:
        // Common injection targets
        $target1 = "aspnet_compiler.exe" ascii wide nocase
        $target2 = "RegSvcs.exe" ascii wide nocase
        $target3 = "notepad.exe" ascii wide nocase
        $target4 = "explorer.exe" ascii wide nocase
        
        // Injection APIs
        $api1 = "VirtualAllocEx" ascii wide
        $api2 = "WriteProcessMemory" ascii wide
        $api3 = "CreateRemoteThread" ascii wide
        $api4 = "NtUnmapViewOfSection" ascii wide
        $api5 = "ZwUnmapViewOfSection" ascii wide
        
        // RunPE / Hollowing
        $hollow1 = "ResumeThread" ascii wide
        $hollow2 = "SetThreadContext" ascii wide
        $hollow3 = "GetThreadContext" ascii wide
        
        // .NET Reflection
        $reflect1 = "Assembly.Load" ascii wide
        $reflect2 = "System.Reflection" ascii wide
        
    condition:
        uint16(0) == 0x5A4D and
        (
            (1 of ($target*) and 2 of ($api*)) or
            (3 of ($hollow*) and 1 of ($api*)) or
            (1 of ($reflect*) and 2 of ($api*))
        )
}

rule AsyncRAT_Configuration {
    meta:
        description = "Detects AsyncRAT configuration and C2 markers"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "high"
        
    strings:
        // Configuration keys
        $config1 = "Ports" ascii wide
        $config2 = "Hosts" ascii wide
        $config3 = "Install" ascii wide
        $config4 = "MTX" ascii wide
        $config5 = "Certificate" ascii wide
        $config6 = "ServerSignature" ascii wide
        
        // Port default
        $port = "6606" ascii wide
        
        // Encryption
        $aes1 = "AES" ascii wide
        $aes2 = "Aes256" ascii wide
        $rsa = "RSA" ascii wide
        
        // AsyncRAT marker
        $async = "AsyncRAT" ascii wide
        
    condition:
        uint16(0) == 0x5A4D and
        (
            (3 of ($config*)) or
            ($async and (2 of ($config*) or $port)) or
            ($port and 1 of ($aes*))
        )
}

rule AsyncRAT_Imphash {
    meta:
        description = "Detects AsyncRAT by common import hash"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "medium"
        reference = "MalwareBazaar observed samples"
        
    condition:
        pe.imphash() == "f34d5f2d4577ed6d9ceec516c1f5a744" or
        pe.imphash() == "87bed5a7cba00c7e1f4015f1bdae2183" or
        pe.imphash() == "fe8d258ea404faca233d63c206abc9ca"
}

rule AsyncRAT_ClickFix_Campaign {
    meta:
        description = "Detects AsyncRAT ClickFix social engineering campaign"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "high"
        reference = "Storm-1865 campaign"
        
    strings:
        // ClickFix indicators
        $click1 = "captcha" ascii wide nocase
        $click2 = "verify" ascii wide nocase
        $click3 = "I'm not a robot" ascii wide nocase
        
        // Command execution
        $cmd1 = "mshta.exe" ascii wide nocase
        $cmd2 = "powershell.exe -w hidden" ascii wide nocase
        $cmd3 = "cmd.exe /c" ascii wide nocase
        
        // Booking.com impersonation
        $booking1 = "booking.com" ascii wide nocase
        $booking2 = "booking" ascii wide nocase
        
        // AsyncRAT
        $async = "AsyncRAT" ascii wide
        
    condition:
        (
            (1 of ($click*) and 1 of ($cmd*)) or
            ($async and 1 of ($booking*))
        )
}

rule AsyncRAT_Python_Loader {
    meta:
        description = "Detects Python-based AsyncRAT loaders"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "high"
        
    strings:
        // Python imports
        $py1 = "import base64" ascii
        $py2 = "import subprocess" ascii
        $py3 = "import ctypes" ascii
        $py4 = "from cryptography" ascii
        
        // Shellcode injection
        $shell1 = "VirtualAlloc" ascii
        $shell2 = "CreateThread" ascii
        $shell3 = "ctypes.windll.kernel32" ascii
        
        // Base64 encoded PE
        $b64 = /TVq[A-Za-z0-9+\/]{100,}/ ascii
        
        // Load function
        $load = "def load(" ascii
        
    condition:
        (3 of ($py*) and 2 of ($shell*)) or
        ($b64 and $load)
}

rule AsyncRAT_Obfuscated_Batch {
    meta:
        description = "Detects obfuscated batch scripts used to deploy AsyncRAT"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "high"
        
    strings:
        // PowerShell invocation
        $ps1 = "powershell" nocase ascii
        $ps2 = "-encodedcommand" nocase ascii
        $ps3 = "-enc" nocase ascii
        $ps4 = "-e " nocase ascii
        
        // Base64 patterns
        $b64_1 = /[A-Za-z0-9+\/]{200,}={0,2}/ ascii
        
        // Decompression
        $decomp1 = "System.IO.Compression.GzipStream" ascii wide
        $decomp2 = "FromBase64String" ascii wide
        $decomp3 = "DeflateStream" ascii wide
        
        // .NET loading
        $net1 = "[Reflection.Assembly]::Load" ascii wide
        $net2 = "System.Reflection.Assembly" ascii wide
        
    condition:
        (1 of ($ps*) and $b64_1 and (1 of ($decomp*) or 1 of ($net*)))
}

rule AsyncRAT_OneNote_Dropper {
    meta:
        description = "Detects OneNote files used to drop AsyncRAT"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "high"
        
    strings:
        // OneNote header
        $header = { E4 52 5C 7B 8C D8 A7 4D AE B1 53 78 D0 29 96 D3 }
        
        // HTA embedded
        $hta1 = "<HTA:APPLICATION" ascii wide nocase
        $hta2 = ".hta" ascii wide nocase
        
        // Batch script
        $bat = ".bat" ascii wide nocase
        
        // AsyncRAT strings
        $async = "AsyncRAT" ascii wide
        
    condition:
        $header at 0 and (1 of ($hta*) or $bat or $async)
}

rule AsyncRAT_TryCloudflare_Infrastructure {
    meta:
        description = "Detects AsyncRAT using TryCloudflare tunnels"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "medium"
        
    strings:
        $cloud1 = "trycloudflare.com" ascii wide nocase
        $cloud2 = "cloudflare" ascii wide nocase
        
        $dropbox1 = "dropbox" ascii wide nocase
        $dropbox2 = "dl.dropboxusercontent.com" ascii wide nocase
        
        $async = "AsyncRAT" ascii wide
        
    condition:
        (1 of ($cloud*) and ($async or 1 of ($dropbox*)))
}

rule AsyncRAT_Desert_Dexter_Variant {
    meta:
        description = "Detects Desert Dexter AsyncRAT variant targeting cryptocurrency"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "critical"
        reference = "Desert Dexter campaign - Middle East/North Africa"
        
    strings:
        // Crypto wallet extensions
        $wallet1 = "MetaMask" ascii wide nocase
        $wallet2 = "Phantom" ascii wide nocase
        $wallet3 = "Coinbase" ascii wide nocase
        $wallet4 = "Binance" ascii wide nocase
        $wallet5 = "Trust Wallet" ascii wide nocase
        
        // Telegram bot
        $telegram1 = "api.telegram.org" ascii wide nocase
        $telegram2 = "sendMessage" ascii wide nocase
        $telegram3 = "bot" ascii wide nocase
        
        // Offline keylogger
        $keylog = "offline" ascii wide nocase
        
        // AsyncRAT
        $async = "AsyncRAT" ascii wide
        
    condition:
        (
            (2 of ($wallet*) and 1 of ($telegram*)) or
            ($async and 2 of ($wallet*))
        )
}

rule AsyncRAT_Memory_Indicators {
    meta:
        description = "Detects AsyncRAT in memory dumps or process inspection"
        author = "Security Analysis Team"
        date = "2025-12-18"
        severity = "high"
        
    strings:
        // Namespace
        $ns1 = "AsyncRAT_Sharp" ascii wide
        $ns2 = "Plugin" ascii wide
        
        // Class names
        $class1 = "Keylogger" ascii wide
        $class2 = "ProcessManager" ascii wide
        $class3 = "ThumbnailDownloader" ascii wide
        $class4 = "RemoteDesktop" ascii wide
        
        // Methods
        $method1 = "GetHashAsync" ascii wide
        $method2 = "StartKeylogger" ascii wide
        $method3 = "CaptureScreen" ascii wide
        
    condition:
        3 of them
}
